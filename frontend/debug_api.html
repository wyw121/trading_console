<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯APIè°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #ccc;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å‰ç«¯APIè°ƒè¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h2>æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
        <div id="service-status">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkServices()">é‡æ–°æ£€æŸ¥</button>
    </div>

    <div class="test-section">
        <h2>è®¤è¯æµ‹è¯•</h2>
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <button onclick="checkToken()">æ£€æŸ¥Token</button>
        <button onclick="testUserInfo()">æµ‹è¯•ç”¨æˆ·ä¿¡æ¯</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2>Dashboard APIæµ‹è¯•</h2>
        <button onclick="testDashboardAPI()">æµ‹è¯•Dashboard API</button>
        <button onclick="testAllAPIs()">æµ‹è¯•æ‰€æœ‰API</button>
        <div id="api-result"></div>
    </div>

    <div class="test-section">
        <h2>è¯¦ç»†æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <textarea id="debug-log" readonly></textarea>
    </div>

    <script>
        const API_BASE = '/api';
        let currentToken = localStorage.getItem('token');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('debug-log');
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logArea.value += logMessage;
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(logMessage);
        }

        function clearLog() {
            document.getElementById('debug-log').value = '';
        }

        async function checkServices() {
            const statusDiv = document.getElementById('service-status');
            statusDiv.innerHTML = 'æ£€æŸ¥ä¸­...';
            
            const checks = [
                { name: 'åç«¯å¥åº·æ£€æŸ¥', url: '/health' },
                { name: 'å‰ç«¯ä»£ç†', url: '/api/health' }
            ];

            let statusHtml = '';
            for (const check of checks) {
                try {
                    const response = await fetch(check.url);
                    if (response.ok) {
                        statusHtml += `<div class="status-item success">âœ… ${check.name}: æ­£å¸¸</div>`;
                        log(`${check.name}: æ­£å¸¸ (${response.status})`);
                    } else {
                        statusHtml += `<div class="status-item error">âŒ ${check.name}: é”™è¯¯ ${response.status}</div>`;
                        log(`${check.name}: é”™è¯¯ ${response.status}`, 'error');
                    }
                } catch (error) {
                    statusHtml += `<div class="status-item error">âŒ ${check.name}: è¿æ¥å¤±è´¥</div>`;
                    log(`${check.name}: è¿æ¥å¤±è´¥ - ${error.message}`, 'error');
                }
            }
            
            statusDiv.innerHTML = statusHtml;
        }

        async function testLogin() {
            log('å¼€å§‹æµ‹è¯•ç™»å½•...');
            try {
                const formData = new FormData();
                formData.append('username', 'admin');
                formData.append('password', 'admin123');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.access_token;
                    localStorage.setItem('token', currentToken);
                    log(`ç™»å½•æˆåŠŸï¼ŒToken: ${currentToken.substring(0, 50)}...`);
                    document.getElementById('auth-result').innerHTML = 
                        '<div class="success">âœ… ç™»å½•æˆåŠŸ</div>';
                } else {
                    const errorText = await response.text();
                    log(`ç™»å½•å¤±è´¥: ${response.status} - ${errorText}`, 'error');
                    document.getElementById('auth-result').innerHTML = 
                        `<div class="error">âŒ ç™»å½•å¤±è´¥: ${response.status}</div>`;
                }
            } catch (error) {
                log(`ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('auth-result').innerHTML = 
                    `<div class="error">âŒ ç™»å½•å¼‚å¸¸: ${error.message}</div>`;
            }
        }

        function checkToken() {
            if (currentToken) {
                log(`å½“å‰Token: ${currentToken.substring(0, 50)}...`);
                document.getElementById('auth-result').innerHTML = 
                    '<div class="success">âœ… Tokenå­˜åœ¨</div>';
            } else {
                log('æ²¡æœ‰Token', 'error');
                document.getElementById('auth-result').innerHTML = 
                    '<div class="error">âŒ æ²¡æœ‰Token</div>';
            }
        }

        async function testUserInfo() {
            if (!currentToken) {
                log('æ²¡æœ‰Tokenï¼Œæ— æ³•æµ‹è¯•ç”¨æˆ·ä¿¡æ¯', 'error');
                return;
            }

            log('æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯...');
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    log(`ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ: ${JSON.stringify(userData)}`);
                    document.getElementById('auth-result').innerHTML = 
                        '<div class="success">âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ</div>';
                } else {
                    const errorText = await response.text();
                    log(`ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥: ${response.status} - ${errorText}`, 'error');
                    document.getElementById('auth-result').innerHTML = 
                        `<div class="error">âŒ ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥: ${response.status}</div>`;
                }
            } catch (error) {
                log(`ç”¨æˆ·ä¿¡æ¯è·å–å¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('auth-result').innerHTML = 
                    `<div class="error">âŒ ç”¨æˆ·ä¿¡æ¯è·å–å¼‚å¸¸: ${error.message}</div>`;
            }
        }

        async function testDashboardAPI() {
            if (!currentToken) {
                log('æ²¡æœ‰Tokenï¼Œå…ˆè¿›è¡Œç™»å½•', 'error');
                await testLogin();
                if (!currentToken) return;
            }

            log('æµ‹è¯•Dashboard API...');
            try {
                const response = await fetch(`${API_BASE}/dashboard/stats`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const dashboardData = await response.json();
                    log(`Dashboardæ•°æ®è·å–æˆåŠŸ: ${JSON.stringify(dashboardData, null, 2)}`);
                    document.getElementById('api-result').innerHTML = 
                        `<div class="success">âœ… Dashboard APIæ­£å¸¸</div>
                         <pre>${JSON.stringify(dashboardData, null, 2)}</pre>`;
                } else {
                    const errorText = await response.text();
                    log(`Dashboard APIå¤±è´¥: ${response.status} - ${errorText}`, 'error');
                    document.getElementById('api-result').innerHTML = 
                        `<div class="error">âŒ Dashboard APIå¤±è´¥: ${response.status}</div>`;
                }
            } catch (error) {
                log(`Dashboard APIå¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('api-result').innerHTML = 
                    `<div class="error">âŒ Dashboard APIå¼‚å¸¸: ${error.message}</div>`;
            }
        }

        async function testAllAPIs() {
            const apis = [
                { name: 'Dashboardç»Ÿè®¡', url: '/dashboard/stats' },
                { name: 'äº¤æ˜“è®°å½•', url: '/trades' },
                { name: 'äº¤æ˜“æ‰€è´¦æˆ·', url: '/exchanges/' },
                { name: 'ç­–ç•¥åˆ—è¡¨', url: '/strategies' }
            ];

            let resultHtml = '';
            for (const api of apis) {
                try {
                    const response = await fetch(`${API_BASE}${api.url}`, {
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        resultHtml += `<div class="success">âœ… ${api.name}: æ­£å¸¸ (${Array.isArray(data) ? data.length : 'object'} é¡¹)</div>`;
                        log(`${api.name}: æ­£å¸¸ - ${JSON.stringify(data).substring(0, 100)}...`);
                    } else {
                        resultHtml += `<div class="error">âŒ ${api.name}: é”™è¯¯ ${response.status}</div>`;
                        log(`${api.name}: é”™è¯¯ ${response.status}`, 'error');
                    }
                } catch (error) {
                    resultHtml += `<div class="error">âŒ ${api.name}: å¼‚å¸¸ ${error.message}</div>`;
                    log(`${api.name}: å¼‚å¸¸ ${error.message}`, 'error');
                }
            }
            
            document.getElementById('api-result').innerHTML = resultHtml;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥æœåŠ¡çŠ¶æ€');
            checkServices();
            checkToken();
        });
    </script>
</body>
</html>
