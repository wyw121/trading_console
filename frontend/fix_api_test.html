<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Console API ä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warning { color: orange; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        textarea { width: 100%; height: 200px; font-family: monospace; padding: 10px; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .api-result { background: white; padding: 10px; border-left: 4px solid #ddd; margin: 5px 0; }
        .api-result.success { border-left-color: green; }
        .api-result.error { border-left-color: red; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Trading Console API ä¿®å¤æµ‹è¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h2>ğŸ”‘ è®¤è¯æµ‹è¯•</h2>
        <button onclick="testFullAuthFlow()">å®Œæ•´è®¤è¯æµ‹è¯•</button>
        <button onclick="getNewToken()">è·å–æ–°Token</button>
        <button onclick="testStoredToken()">æµ‹è¯•æœ¬åœ°Token</button>
        <div id="auth-status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š APIç«¯ç‚¹æµ‹è¯•</h2>
        <div class="status-grid">
            <button onclick="testAPI('/api/dashboard/stats', 'Dashboardç»Ÿè®¡')">Dashboardç»Ÿè®¡</button>
            <button onclick="testAPI('/api/strategies', 'ç­–ç•¥åˆ—è¡¨')">ç­–ç•¥åˆ—è¡¨</button>
            <button onclick="testAPI('/api/trades', 'äº¤æ˜“è®°å½•')">äº¤æ˜“è®°å½•</button>
            <button onclick="testAPI('/api/exchanges/', 'äº¤æ˜“æ‰€è´¦æˆ·')">äº¤æ˜“æ‰€è´¦æˆ·</button>
        </div>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="saveResults()">ä¿å­˜ç»“æœ</button>
        <textarea id="log-area" readonly></textarea>
    </div>    <script>
        const API_BASE = '/api';
        // æµ‹è¯•ç›´æ¥è¿æ¥åç«¯çš„base URLï¼ˆç”¨äºè°ƒè¯•ï¼‰
        const DIRECT_API_BASE = 'http://localhost:8000/api';
        let currentToken = localStorage.getItem('token');
        let useDirectAPI = false; // åˆ‡æ¢æ˜¯å¦ä½¿ç”¨ç›´æ¥APIè¿æ¥
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('log-area');
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logArea.value += logMessage;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(logMessage);
        }

        function updateAuthStatus(message, isSuccess = true) {
            const authStatus = document.getElementById('auth-status');
            authStatus.innerHTML = `<div class="${isSuccess ? 'success' : 'error'}">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('log-area').value = '';
        }        async function getNewToken() {
            log('å¼€å§‹è·å–æ–°Token...');
            const baseURL = useDirectAPI ? DIRECT_API_BASE : API_BASE;
            
            try {
                const formData = new FormData();
                formData.append('username', 'admin');
                formData.append('password', 'admin123');

                const response = await fetch(`${baseURL}/auth/login`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.access_token;
                    localStorage.setItem('token', currentToken);
                    log(`âœ… æ–°Tokenè·å–æˆåŠŸ: ${currentToken.substring(0, 50)}...`);
                    updateAuthStatus(`âœ… æ–°Tokenè·å–æˆåŠŸ (${new Date().toLocaleTimeString()})`);
                    return currentToken;
                } else {
                    const errorText = await response.text();
                    log(`âŒ è·å–Tokenå¤±è´¥: ${response.status} - ${errorText}`, 'error');
                    updateAuthStatus(`âŒ è·å–Tokenå¤±è´¥: ${response.status}`, false);
                    
                    // å¦‚æœä»£ç†å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿æ¥
                    if (!useDirectAPI && response.status === 404) {
                        log('ğŸ”„ ä»£ç†å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿æ¥åç«¯...', 'warning');
                        useDirectAPI = true;
                        return await getNewToken();
                    }
                    
                    return null;
                }
            } catch (error) {
                log(`âŒ Tokenè·å–å¼‚å¸¸: ${error.message}`, 'error');
                updateAuthStatus(`âŒ Tokenè·å–å¼‚å¸¸: ${error.message}`, false);
                
                // å¦‚æœä»£ç†å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿æ¥
                if (!useDirectAPI) {
                    log('ğŸ”„ ä»£ç†è¿æ¥å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿æ¥åç«¯...', 'warning');
                    useDirectAPI = true;
                    return await getNewToken();
                }
                
                return null;
            }
        }

        async function testStoredToken() {
            if (!currentToken) {
                log('âš ï¸ æ²¡æœ‰å­˜å‚¨çš„Tokenï¼Œå°è¯•è·å–æ–°çš„', 'warning');
                return await getNewToken();
            }

            log('æµ‹è¯•å­˜å‚¨çš„Token...');
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const userData = await response.json();
                    log(`âœ… å­˜å‚¨çš„Tokenæœ‰æ•ˆï¼Œç”¨æˆ·: ${userData.username}`);
                    updateAuthStatus(`âœ… Tokenæœ‰æ•ˆ - ç”¨æˆ·: ${userData.username}`);
                    return currentToken;
                } else {
                    log(`âŒ å­˜å‚¨çš„Tokenæ— æ•ˆ: ${response.status}`, 'error');
                    updateAuthStatus('âŒ å­˜å‚¨çš„Tokenæ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•', false);
                    return await getNewToken();
                }
            } catch (error) {
                log(`âŒ TokenéªŒè¯å¼‚å¸¸: ${error.message}`, 'error');
                return await getNewToken();
            }
        }

        async function testFullAuthFlow() {
            log('=== å¼€å§‹å®Œæ•´è®¤è¯æµç¨‹æµ‹è¯• ===');
            
            // æ¸…é™¤ç°æœ‰Token
            localStorage.removeItem('token');
            currentToken = null;
            
            // è·å–æ–°Token
            const token = await getNewToken();
            if (!token) {
                log('âŒ è®¤è¯æµç¨‹å¤±è´¥ï¼Œæ— æ³•è·å–Token', 'error');
                return false;
            }

            // æµ‹è¯•ç”¨æˆ·ä¿¡æ¯
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const userData = await response.json();
                    log(`âœ… ç”¨æˆ·ä¿¡æ¯éªŒè¯æˆåŠŸ: ${JSON.stringify(userData)}`);
                    
                    // æµ‹è¯•æ‰€æœ‰ä¸»è¦API
                    await testAllAPIs();
                    return true;
                } else {
                    log(`âŒ ç”¨æˆ·ä¿¡æ¯éªŒè¯å¤±è´¥: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ ç”¨æˆ·ä¿¡æ¯éªŒè¯å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function testAPI(endpoint, name) {
            if (!currentToken) {
                log('âš ï¸ æ²¡æœ‰Tokenï¼Œå…ˆè·å–Token', 'warning');
                await getNewToken();
            }

            log(`æµ‹è¯• ${name} (${endpoint})...`);
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const resultsDiv = document.getElementById('api-results');
                
                if (response.ok) {
                    const data = await response.json();
                    let dataInfo = '';
                    
                    if (Array.isArray(data)) {
                        dataInfo = `æ•°ç»„ï¼Œ${data.length}ä¸ªé¡¹ç›®`;
                        if (data.length > 0) {
                            log(`âœ… ${name}: æˆåŠŸè·å–${data.length}ä¸ªé¡¹ç›®`);
                            if (endpoint === '/api/strategies') {
                                log(`ç­–ç•¥è¯¦æƒ…: ${data.map(s => s.name).join(', ')}`);
                            }
                        } else {
                            log(`âœ… ${name}: æˆåŠŸä½†æ•°æ®ä¸ºç©º`);
                        }
                    } else {
                        dataInfo = 'å¯¹è±¡æ•°æ®';
                        log(`âœ… ${name}: æˆåŠŸè·å–å¯¹è±¡æ•°æ®`);
                        if (endpoint === '/api/dashboard/stats') {
                            log(`Dashboardæ•°æ®: ç­–ç•¥${data.total_strategies}ä¸ª, ä½™é¢${data.account_balances?.length || 0}ä¸ª`);
                        }
                    }

                    resultsDiv.innerHTML += `
                        <div class="api-result success">
                            <strong>âœ… ${name}</strong><br>
                            çŠ¶æ€: 200 OK<br>
                            æ•°æ®: ${dataInfo}<br>
                            <pre>${JSON.stringify(data, null, 2).substring(0, 500)}${JSON.stringify(data, null, 2).length > 500 ? '...' : ''}</pre>
                        </div>
                    `;
                } else {
                    log(`âŒ ${name}: å¤±è´¥ ${response.status}`, 'error');
                    const errorText = await response.text();
                    
                    resultsDiv.innerHTML += `
                        <div class="api-result error">
                            <strong>âŒ ${name}</strong><br>
                            çŠ¶æ€: ${response.status}<br>
                            é”™è¯¯: ${errorText}
                        </div>
                    `;

                    // å¦‚æœæ˜¯401é”™è¯¯ï¼Œå°è¯•é‡æ–°è·å–Token
                    if (response.status === 401) {
                        log('ğŸ”„ æ£€æµ‹åˆ°401é”™è¯¯ï¼Œå°è¯•é‡æ–°è·å–Token', 'warning');
                        await getNewToken();
                    }
                }
            } catch (error) {
                log(`âŒ ${name} è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                
                const resultsDiv = document.getElementById('api-results');
                resultsDiv.innerHTML += `
                    <div class="api-result error">
                        <strong>âŒ ${name}</strong><br>
                        å¼‚å¸¸: ${error.message}
                    </div>
                `;
            }
        }

        async function testAllAPIs() {
            log('=== å¼€å§‹æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹ ===');
            document.getElementById('api-results').innerHTML = '';
            
            const apis = [
                ['/api/dashboard/stats', 'Dashboardç»Ÿè®¡'],
                ['/api/strategies', 'ç­–ç•¥åˆ—è¡¨'],
                ['/api/trades', 'äº¤æ˜“è®°å½•'],
                ['/api/exchanges/', 'äº¤æ˜“æ‰€è´¦æˆ·']
            ];

            for (const [endpoint, name] of apis) {
                await testAPI(endpoint, name);
                // çŸ­æš‚å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('=== APIæµ‹è¯•å®Œæˆ ===');
        }

        function saveResults() {
            const results = {
                timestamp: new Date().toISOString(),
                token: currentToken ? currentToken.substring(0, 50) + '...' : 'None',
                authStatus: document.getElementById('auth-status').innerHTML,
                apiResults: document.getElementById('api-results').innerHTML,
                logs: document.getElementById('log-area').value
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_console_test_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('âœ… æµ‹è¯•ç»“æœå·²ä¿å­˜');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥TokençŠ¶æ€
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ£€æŸ¥...');
            testStoredToken();
        });
    </script>
</body>
</html>
